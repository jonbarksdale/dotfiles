#!/usr/bin/env bash
# ABOUTME: Installs Doom Emacs to ~/.config/emacs if not present
# ABOUTME: Doom manages its own updates via 'doom upgrade'

set -euo pipefail

DOOM_DIR="${HOME}/.config/emacs"
DOOM_REPO="https://github.com/doomemacs/doomemacs"

# Check if doom is already installed
if [[ -d "${DOOM_DIR}" ]] && [[ -f "${DOOM_DIR}/bin/doom" ]]; then
    echo "✓ Doom Emacs already installed at ${DOOM_DIR}"
    exit 0
fi

# Handle legacy ~/.emacs.d installation
if [[ -d "${HOME}/.emacs.d" ]] && [[ -f "${HOME}/.emacs.d/bin/doom" ]]; then
    echo "Found Doom at legacy location ~/.emacs.d"
    echo "Consider moving to ~/.config/emacs with: mv ~/.emacs.d ~/.config/emacs"
    exit 0
fi

# Clean up old symlink if present
if [[ -L "${HOME}/.emacs.d" ]]; then
    echo "Removing old symlink at ~/.emacs.d"
    rm "${HOME}/.emacs.d"
fi

# Install Doom Emacs
echo "Installing Doom Emacs to ${DOOM_DIR}..."
git clone --depth 1 "${DOOM_REPO}" "${DOOM_DIR}"

echo ""
echo "✓ Doom Emacs cloned successfully"
echo ""
echo "To complete installation, run:"
echo "  ${DOOM_DIR}/bin/doom install"
echo ""
echo "To update Doom later, run:"
echo "  doom upgrade"

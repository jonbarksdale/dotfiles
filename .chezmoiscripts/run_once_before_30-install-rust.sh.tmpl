#!/usr/bin/env bash
# ABOUTME: Installs Rust toolchain via rustup and cargo packages
# ABOUTME: Installs: choose, rm-improved, tokei (xcp and whyq installed via Homebrew)

set -euo pipefail

# Install rustup if not already installed
if ! command -v rustup &> /dev/null; then
    echo "Installing rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path

    # Source cargo env for this script
    source "$HOME/.cargo/env"
    echo "✓ Rustup installed successfully"
else
    echo "✓ Rustup is already installed"
fi

# Ensure cargo is in PATH
if [[ -f "$HOME/.cargo/env" ]]; then
    source "$HOME/.cargo/env"
fi

# Install cargo packages if not already installed
# Note: xcp is installed via Homebrew for faster installation
declare -A cargo_packages=(
    ["choose"]="choose"
    ["rip"]="rm-improved"
    ["tokei"]="tokei --features all"
    ["whyq"]="whyq"
)

echo "Installing cargo packages..."

for cmd in "${!cargo_packages[@]}"; do
    if command -v "$cmd" &> /dev/null; then
        echo "✓ $cmd is already installed"
    else
        echo "Installing ${cargo_packages[$cmd]}..."
        cargo install ${cargo_packages[$cmd]}
    fi
done

echo "✓ All cargo packages installed successfully"

#!/usr/bin/env bash
# ABOUTME: Installs all Homebrew packages, casks, and fonts from ~/.Brewfile
# ABOUTME: Uses Homebrew Bundle to install formulae, casks, and configure taps
#
# chezmoi:onchange-hash:{{ includeTemplate "dot_Brewfile" | sha256sum }}

set -euo pipefail

# Ensure Homebrew is in PATH
if [[ -f "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi

# Set cask installation directory to user Applications folder
export HOMEBREW_CASK_OPTS="--appdir=${HOME}/Applications"

echo "Installing packages from Brewfile..."

# Use the source Brewfile directly since this is a run_onchange_before script
# that executes when dot_Brewfile changes (before it's applied to ~/.Brewfile)
CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
BREWFILE="${CHEZMOI_SOURCE}/dot_Brewfile"

if [[ ! -f "${BREWFILE}" ]]; then
    echo "âš  Brewfile not found at: ${BREWFILE}"
    exit 1
fi

# Install from Brewfile
brew bundle --file="${BREWFILE}" --verbose

#!/usr/bin/env bash
# ABOUTME: Installs all Homebrew packages, casks, and fonts from ~/.Brewfile
# ABOUTME: Uses Homebrew Bundle to install formulae, casks, and configure taps
#
# chezmoi:onchange-hash:{{ includeTemplate "dot_Brewfile" | sha256sum }}

set -euo pipefail

# Ensure Homebrew is in PATH
if [[ -f "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi

# Set cask installation directory to user Applications folder
export HOMEBREW_CASK_OPTS="--appdir=${HOME}/Applications"

echo "Installing packages from Brewfile..."

# First check if Brewfile exists in home directory (already applied)
BREWFILE="${HOME}/.Brewfile"

# If not, check in chezmoi source directory
if [[ ! -f "${BREWFILE}" ]]; then
    CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"
    if [[ -f "${CHEZMOI_SOURCE}/dot_Brewfile" ]]; then
        echo "Using Brewfile from chezmoi source directory"
        BREWFILE="${CHEZMOI_SOURCE}/dot_Brewfile"
    else
        echo "âš  Brewfile not found in either location:"
        echo "  - ${HOME}/.Brewfile"
        echo "  - ${CHEZMOI_SOURCE}/dot_Brewfile"
        exit 1
    fi
fi

# Install from Brewfile
brew bundle --file="${BREWFILE}" --verbose

;; Bootstrap straight.el package manager
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

(straight-use-package 'use-package)

;; for monkey patching stuff
(use-package el-patch
  :straight (:host github
                   :repo "raxod502/el-patch"
                   :branch "develop"))
(eval-when-compile
  (require 'el-patch))

(setq evil-want-keybinding nil)
(use-package evil
  :straight t
  :config
  (setq
    evil-mode-line-format 'before
    evil-emacs-state-cursor  '("red" box)
    evil-normal-state-cursor '("gray" box)
    evil-visual-state-cursor '("gray" box)
    evil-insert-state-cursor '("gray" bar)
    evil-motion-state-cursor '("gray" box))
  (evil-ex-define-cmd "ls" 'ibuffer)
  (evil-mode 1)
  )
(use-package evil-surround
  :straight t
  :config
  (global-evil-surround-mode 1))
(use-package evil-matchit
  :straight t)
(use-package evil-collection
  :straight t)

;; Fix paste from clipboard in evil mode
;; ref - https://emacs.stackexchange.com/questions/14940/emacs-doesnt-paste-in-evils-visual-mode-with-every-os-clipboard/15054
(fset 'evil-visual-update-x-selection 'ignore)

(use-package org
  :straight t
  :bind ("A-<tab>" . pcomplete)
  :config
  (setq org-refile-targets '((nil :maxlevel . 9)
                             (org-agenda-files :maxlevel . 2))
        org-refile-use-outline-path 'file
        org-outline-path-complete-in-steps nil
        )
  )

(setq org-capture-templates
      '(
        ("i" "inbox")
        ("iw" "Work inbox" entry (file+headline "~/Dropbox/org/work.org" "Inbox")
         "* TODO %?\n %i")
        ("ip" "Personal inbox" entry (file+headline "~/Dropbox/org/personal.org" "Inbox")
         "* TODO %?\n %i")
        ("p" "project")
        ("pw" "Work project" entry (file+headline "~/Dropbox/org/work.org" "Active Projects")
         "* TODO %?\n %i")
        ("pp" "Personal project" entry (file+headline "~/Dropbox/org/personal.org" "Projects")
         "* TODO %?\n %i")
        ("b" "Book suggestion" entry (file+headline "~/Dropbox/org/personal.org" "Media")
         "* BACKLOG %^{title} :book:%^g" :immediate-finish t)
        ("g" "Game suggestion" entry (file+headline "~/Dropbox/org/personal.org" "Media")
         "* BACKLOG %^{title} :game:%^g" :immediate-finish t)
        )
      )

(use-package org-evil
  :straight t
  :after org
  )
(use-package evil-org
  :straight t
  :after org
  :config
  (add-hook 'org-mode-hook 'evil-org-mode)
  (add-hook 'evil-org-mode-hook
        (lambda ()
          (evil-org-set-key-theme)))
  (require 'evil-org-agenda)
  (evil-org-agenda-set-keys)
  (evil-declare-key 'normal org-mode-map
    "t" 'org-todo ; mark a TODO item as done
    "$" 'org-end-of-line ; org specific eol behavor
    "^" 'org-beginning-of-line ; org specific eol behavor
    ))

(use-package deft
  :after org
  :bind
  ("C-c n d" . deft)
  :straight t
  :commands deft
  :custom
  (deft-default-extension "org")
  (deft-recursive t)
  (deft-directory "~/Dropbox/org-roam")
  (deft-extensions '("org" "md" "markdown" "txt" "text"))
  ;; 100% stolen from https://github.com/jethrokuan/.emacs.d/blob/master/init.el
  :config/el-patch
  (defun deft-parse-title (file contents)
    "Parse the given FILE and CONTENTS and determine the title.
If `deft-use-filename-as-title' is nil, the title is taken to
be the first non-empty line of the FILE.  Else the base name of the FILE is
used as title."
    (el-patch-swap (if deft-use-filename-as-title
                       (deft-base-filename file)
                     (let ((begin (string-match "^.+$" contents)))
                       (if begin
                           (funcall deft-parse-title-function
                                    (substring contents begin (match-end 0))))))
                   (org-roam--get-title-or-slug file))))
  
;; (setq deft-use-filter-string-for-filename t
;;       deft-file-naming-rules
;;         '((noslash . "-")
;;           (nospace . "-")
;;           (case-fn . downcase))
;;       deft-markdown-mode-title-level 1
;;       deft-org-mode-title-prefix t)

(use-package org-journal
  :after org
  :bind
  ("C-c n j" . org-journal-new-entry)
  :custom
  (org-journal-date-prefix "#+TITLE: ")
  (org-journal-file-format "%Y-%m-%d.org")
  (org-journal-dir "~/Dropbox/org-roam")
  (org-journal-date-format "%A, %d %B %Y"))

(use-package org-roam
  :ensure t
  :after org
  :hook
  ((org-mode . org-roam-mode)
   (after-init . org-roam--build-cache-async)
   )
  :straight (:host github :repo "jethrokuan/org-roam" :branch "develop")
  :custom
  (org-roam-directory "~/Dropbox/org-roam")
  :bind
      ("C-c n l" . org-roam)
      ("C-c n t" . org-roam-today)
      ("C-c n f" . org-roam-find-file)
      ("C-c n i" . org-roam-insert)
      ("C-c n g" . org-roam-show-graph))

(use-package markdown-mode
  :straight t
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.md\\'" . markdown-mode)
         ("\\.markdown\\'" . markdown-mode))
  :init (setq markdown-command "multimarkdown"))

(use-package helm
  :straight t
  :init
  (custom-set-variables '(helm-command-prefix-key "C-c h"))
  :config
  
  (setq
   helm-split-window-in-side-p t
   helm-buffers-fuzzy-matching t
   helm-move-to-line-cycle-in-source t
   helm-ff-search-library-in-sexp t
   helm-ff-file-name-history-use-recentf t
   )
  (bind-keys ("C-x b" . helm-mini)
             ("M-x" . helm-M-x)
             ("M-y" . helm-show-kill-ring)
             ("C-x C-b" . helm-buffers-list)
             ("C-x C-f" . helm-find-files)
             ("C-h f" . helm-apropos)
             ("C-h r" . helm-info-emacs)
             ("C-h C-l" . helm-locate-library))
  (bind-keys :map isearch-mode-map
             ("C-o" . helm-occur-from-isearch))
  (require 'helm-config)
  (bind-keys :map helm-command-map
             ("o" . helm-occur)
             ("g" . helm-do-grep)
             ("y" . yas-insert-snippet))
  (helm-mode 1))

(use-package helm-ag
  :straight t)
(use-package helm-descbinds
  :straight t)

(use-package helm-org
  :straight t
  :after (helm org)
  :config
    (add-to-list 'helm-completing-read-handlers-alist '(org-capture . helm-org-completing-read-tags))
    (add-to-list 'helm-completing-read-handlers-alist '(org-set-tags . helm-org-completing-read-tags))
  )

(use-package magit
  :straight t
  :bind ("C-x g" . magit-status))
(use-package evil-magit
  :straight t)
(use-package projectile
  :straight t)

(use-package kotlin-mode
  :straight t)

(use-package zenburn-theme
  :straight t)
(load-theme 'zenburn t)

(setq plantuml-jar-path
      (expand-file-name "~/.emacs.d/plantuml/plantuml.jar"))

(use-package plantuml-mode
  :straight t
  :config 
          (setq plantuml-jar-path plantuml-jar-path)
          (setq plantuml-default-exec-mode 'jar))

(setq org-plantuml-jar-path plantuml-jar-path)
(org-babel-do-load-languages
 'org-babel-load-languages
 '((plantuml . t)))

(add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images)

(use-package auto-package-update
  :straight t
  :config
  (setq auto-package-update-delete-old-versions t)
  (setq auto-package-update-hide-results t)
  (auto-package-update-maybe))

(progn
  (unless (or (fboundp 'helm-mode) (fboundp 'ivy-mode))
    (ido-mode t)
    (setq ido-enable-flex-matching t)))

(use-package yasnippet
  :straight t
  :config
  (yas-global-mode 1))

(use-package yasnippet-snippets
  :straight t
  :after yasnippet )

(use-package rainbow-delimiters
  :straight t
  :hook (prog-mode . rainbow-delimiters-mode))

(use-package langtool
  :straight t
  :config
;;  (setq langtool-language-tool-jar "/usr/local/Cellar/languagetool/4.8/libexec/languagetool-commandline.jar")
  (setq langtool-bin "/usr/local/bin/languagetool"
        langtool-disabled-rules '("WHITESPACE_RULE"
                                  "ARROWS"
                                  "DASH_RULE"
                                  "COMMA_PARENTHESIS_WHITESPACE"
                                  "EN_QUOTES")))
(use-package csv-mode
  :straight t
  :init
  (add-to-list 'auto-mode-alist '("\\.[Cc][Ss][Vv]\\'" . csv-mode)))

(use-package auto-complete
  :straight t
  :config
  (ac-config-default))

(use-package org-ac
  :straight t
  :init
  (org-ac/config-default))

(use-package which-key
  :straight t
  :config
  (which-key-mode +1))

(use-package beacon
  :straight t
  :config
  (beacon-mode +1))

(use-package org-brain
  :straight t				
  :init
  (setq org-brain-path "~/brain")
  (with-eval-after-load 'evil
    (evil-set-initial-state 'org-brain-visualize-mode 'emacs))
  :config 
    (setq org-id-track-globally t)
)

(require 'uniquify)
(setq uniquify-buffer-name-style 'forward)

(global-set-key (kbd "C-c l") 'org-store-link)
(global-set-key (kbd "C-c a") 'org-agenda)
(global-set-key (kbd "C-c c") 'org-capture)
(global-set-key (kbd "C-c b") 'org-switchb)
(global-set-key (kbd "C-c v") 'org-brain-visualize)

(global-set-key (kbd "M-/") 'hippie-expand)
(global-set-key (kbd "C-x C-b") 'ibuffer)
(global-set-key (kbd "C-s") 'isearch-forward-regexp)
(global-set-key (kbd "C-r") 'isearch-backward-regexp)
(global-set-key (kbd "C-M-s") 'isearch-forward)
(global-set-key (kbd "C-M-r") 'isearch-backward)

;; Save last place I was in a file
;; https://www.emacswiki.org/emacs/SavePlace
(save-place-mode 1)

;; show matching parens
(show-paren-mode 1)

;; mode line settings
(line-number-mode t)
(column-number-mode t)
(size-indication-mode t)

;; backup configuration
;; Default and per-save backups go here:
(setq backup-directory-alist '(("" . "~/.emacs.d/backup/per-save")))

(setq vc-make-backup-files t)

(setq version-control t ;; Use version numbers for backups.
    kept-new-versions 10 ;; Number of newest versions to keep.
    kept-old-versions 0 ;; Number of oldest versions to keep.
    delete-old-versions t ;; Don't ask to delete excess backup versions.
    backup-by-copying t) ;; Copy all files, don't rename them.

;; set the default font to victor on a mac
(when (eq system-type 'darwin)
  (set-face-attribute 'default nil :family "Victor Mono")
  (mac-auto-operator-composition-mode))

;; set frame title
(setq frame-title-format
        '(buffer-file-name "%f"
        (dired-directory dired-directory "%b")))

(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(apropos-do-all t)
 '(face-font-family-alternatives
   (quote
    (("Monospace" "Victor Mono" "courier" "fixed")
     ("Monospace Serif" "Victor Mono" "Courier 10 Pitch" "Consolas" "Courier Std" "FreeMono" "Nimbus Mono L" "courier" "fixed")
     ("courier" "CMU Typewriter Text" "fixed")
     ("Sans Serif" "helv" "helvetica" "arial" "fixed")
     ("helv" "helvetica" "arial" "fixed"))))
 '(fill-column 100)
 '(helm-command-prefix-key "C-c h")
 '(helm-completion-style (quote emacs))
 '(helm-mode t)
 '(indent-tabs-mode nil)
 '(inhibit-startup-screen t)
 '(load-prefer-newer t)
 '(org-agenda-files
   (quote
    ("~/Dropbox/org/personal.org" "~/Dropbox/org/work.org")))
 '(org-log-done (quote time))
 '(org-log-into-drawer t)
 '(org-modules
   (quote
    (org-bbdb org-bibtex org-docview org-gnus org-habit org-info org-irc org-mhe org-rmail org-w3m)))
 '(package-selected-packages
   (quote
    (org-ac auto-complete org orgit beacon which-key helm-org evil-magit helm-descbinds helm-ag helm-mode helm-config org-brain csv-mode rainbow-delimiters langtool plantuml-mode mmm-mode yasnippet-snippets ya-snippet evil-org-agenda markdown-mode deft evil-collection evil-org auto-package-update projectile org-evil evil-matchit evil-surround magit helm evil use-package)))
 '(require-final-newline t)
 '(safe-local-variable-values (quote ((truncate-lines . f))))
 '(save-interprogram-paste-before-kill t)
 '(visible-bell t))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )
